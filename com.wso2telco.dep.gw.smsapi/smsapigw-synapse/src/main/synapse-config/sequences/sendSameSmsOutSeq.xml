<?xml version="1.0" encoding="UTF-8"?>
<sequence name="sendSameSmsOutSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <class name="org.wso2telco.dep.nashornmediator.NashornMediator">
        <property name="script" value='
            var payload= mc.getPayloadJSON();
            // get the request id sent from operator side
            var responseResourceUrl = payload.outboundSMSMessageRequest.resourceURL;
            var operatorRequestId = responseResourceUrl.substring(responseResourceUrl.lastIndexOf("/") + 1);
            if (!operatorRequestId) {
            throw "ERROR - Unable extract operator request id (plugin_requestid) from response";
            }
            // set request id sent from operator side to message context
            mc.setProperty("SEND_SMS_OPERATOR_REQUEST_ID", operatorRequestId);
        '/>
    </class>
		
    <class name="com.wso2telco.dep.mediator.impl.smsmessaging.SendSMSRequestIdGetMediator"/>

    <class name="org.wso2telco.dep.nashornmediator.NashornMediator">
        <property name="script" value='
            var payload= mc.getPayloadJSON();
            var smsRetrieveResourceUrlPrefix = mc.getProperty("SEND_SMS_RESOURCE_URL_PREFIX").trim();
            var encodedSenderAddress = mc.getProperty("ENCODED_SENDER_ADDRESS").trim();
            var requestId = mc.getProperty("PERSISTED_REQUEST_ID").trim();
            var resourceUrl = smsRetrieveResourceUrlPrefix + "/" + encodedSenderAddress + "/requests/" + requestId;
            if (mc.getProperty("originalNotifyURL")) {
            payload.outboundSMSMessageRequest.receiptRequest.notifyURL = mc.getProperty("originalNotifyURL");
            }
            payload.outboundSMSMessageRequest.resourceURL = resourceUrl;
            payload.outboundSMSMessageRequest.deliveryInfoList.resourceURL = resourceUrl + "/deliveryInfos";
            mc.setPayloadJSON(payload);
        '/>
    </class>
</sequence>
